
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å½°åŒ–ä¸‰å¯¶ç¾é£Ÿåœ°åœ–ï½œè‚‰åœ“ãƒ»çˆŒè‚‰é£¯ãƒ»ç´ é£Ÿéºµ</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
</head>
<body>
  <header class="hero">
    <img class="art" src="header-art.svg" alt="å¯æ„›æ’ç•«èƒŒæ™¯" />
    <img class="logo" src="logo.svg" alt="Changhua 3 Treasures" />
    <h1>å½°åŒ–ä¸‰å¯¶ç¾é£Ÿåœ°åœ–</h1>
    <p class="subtitle">è‚‰åœ“ãƒ»çˆŒè‚‰é£¯ãƒ»ç´ é£Ÿéºµï½œå¯æ„›åˆå¹³æ˜“è¿‘äººçš„åƒè²¨æŒ‡å—</p>
    <div class="actions">
      <div class="chips" id="chips"></div>
      <div class="toolbar">
        <button id="btnGeocode" class="chip">ğŸ—ºï¸ ä¸€æ¬¡è£œé½Šåº§æ¨™</button>
        <button id="btnExport" class="chip">ğŸ’¾ åŒ¯å‡ºåº§æ¨™ JSON</button>
        <span id="progress" class="progress"></span>
      </div>
    </div>
  </header>

  <main class="layout">
    <section id="cards" class="cards"></section>
    <aside class="map-wrap">
      <div id="map" class="map"></div>
    </aside>
  </main>

  <footer>
    <small>æç¤ºï¼šæœ¬é æ”¯æ´ PWA å¯é›¢ç·šï¼›å¦‚ä»æœ‰åº—å®¶ç¼ºåº§æ¨™ï¼ŒæŒ‰ã€Œä¸€æ¬¡è£œé½Šåº§æ¨™ã€å°‡ä»¥æ¯ç§’ä¸€ç­†æŸ¥è©¢ Nominatimï¼ˆOpenStreetMapï¼‰ã€‚</small>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="data.js"></script>
  <script>
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js'); }
    const categories = [
      {key:'rouyuan', name:'è‚‰åœ“', icon:'icon_rouyuan.svg'},
      {key:'kongroufan', name:'çˆŒè‚‰é£¯', icon:'icon_kongroufan.svg'},
      {key:'sushi', name:'ç´ é£Ÿéºµ', icon:'icon_sushi.svg'}
    ];
    let active = 'rouyuan';
    const chipsBox = document.getElementById('chips');
    function renderChips(){
      chipsBox.innerHTML = '';
      categories.forEach(c=>{
        const b = document.createElement('button');
        b.className = 'chip' + (c.key===active?' active':'');
        b.innerHTML = `<img src="${c.icon}" class="chip-icon" alt=""/> ${c.name}`;
        b.onclick = ()=>{ active=c.key; renderCards(); updateMarkers(); };
        chipsBox.appendChild(b);
      });
    }
    function ratingClass(score){
      const s = Number(score||0);
      if(s>=4.5) return 'rating rating--gold';
      if(s>=4.0) return 'rating rating--green';
      return 'rating rating--gray';
    }
    function starHTML(score){
      const s = Number(score||0);
      const full = Math.round(s);
      return 'â­'.repeat(full) + (s?` <span class="score">${s.toFixed(1)}</span>`:'');
    }
    function badgeHTML(row){
      const badges = [];
      const t = String(row.time||'');
      if(/(21:|22:|23:|00:|01:|02:|03:)/.test(t)) badges.push('æ·±å¤œå ´');
      if((row.description||'').includes('ç™¾å¹´')||(row.feature||'').includes('ç™¾å¹´')) badges.push('è€åº—');
      if(Number(row.google)>=4.5) badges.push('äººæ°£ç‹');
      return badges.map(b=>`<span class="badge">${b}</span>`).join('');
    }
    const map = L.map('map').setView([24.08, 120.54], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
    const cluster = L.markerClusterGroup();
    const nameToMarker = new Map();
    function updateMarkers(){
      cluster.clearLayers();
      nameToMarker.clear();
      const rows = data.filter(r=>r.category===active && r.lat && r.lng);
      rows.forEach(r=>{
        const m = L.marker([r.lat, r.lng]);
        m.bindPopup(`<strong>${r.name}</strong><br>${r.address||''}<br/>è©•åˆ†ï¼š${r.google||''}`);
        cluster.addLayer(m);
        nameToMarker.set(r.name, m);
      });
      map.addLayer(cluster);
    }
    function renderCards(){
      const box = document.getElementById('cards');
      box.innerHTML = '';
      const rows = data.filter(r=>r.category===active);
      rows.forEach(r=>{
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-top">
            <h3>${r.name}</h3>
            <div class="badges">${badgeHTML(r)}</div>
          </div>
          <p class="addr">${r.address||''}</p>
          <p class="feat">${r.feature||''}</p>
          <p class="dish">ğŸ½ï¸ ${r.dish||''}</p>
          <p class="time">ğŸ•’ ${r.time||''}</p>
          <p class="phone">ğŸ“ ${r.phone||''}</p>
          <div class="${ratingClass(r.google)}">${starHTML(r.google)}</div>
        `;
        card.onclick = ()=>{
          const mk = nameToMarker.get(r.name);
          if(mk){ mk.openPopup(); map.flyTo(mk.getLatLng(), 16, {duration:0.7}); }
        };
        box.appendChild(card);
      })
    }
    // Geocoding & export (ä¿ç•™ä»¥è£œå°‘æ•¸æ¼ç¶²åº—å®¶)
    const progress = document.getElementById('progress');
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
    async function geocodeAll(){
      const baseUrl = 'https://nominatim.openstreetmap.org/search?format=json&q=';
      const pending = data.filter(r=>!(r.lat && r.lng));
      let done = 0;
      for(const row of pending){
        const key = 'geo:' + (row.address||'');
        const cached = localStorage.getItem(key);
        if(cached){
          try{ const {lat,lng} = JSON.parse(cached); row.lat=lat; row.lng=lng; done++; progress.textContent = `å·²è¼‰å…¥å¿«å–ï¼š${done}/${pending.length}`; continue; }catch{}
        }
        progress.textContent = `æŸ¥è©¢ä¸­ï¼š${done+1}/${pending.length} - ${row.name}`;
        try{
          const resp = await fetch(baseUrl + encodeURIComponent(row.address||''), { headers:{'Accept':'application/json'} });
          const arr = await resp.json();
          if(Array.isArray(arr) && arr.length){
            const lat = parseFloat(arr[0].lat), lng = parseFloat(arr[0].lon);
            row.lat = lat; row.lng = lng; localStorage.setItem(key, JSON.stringify({lat,lng}));
          }
        }catch(err){ console.warn('geocode error', err); }
        await sleep(1100); done++;
      }
      progress.textContent = 'åº§æ¨™è£œé½Šå®Œæˆ';
      renderCards(); updateMarkers();
    }
    document.getElementById('btnGeocode').onclick = geocodeAll;
    document.getElementById('btnExport').onclick = ()=>{
      const out = data.map(({name,address,lat,lng})=>({name,address,lat,lng}));
      const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'changhua_coords_merged.json'; a.click();
    };
    renderChips(); renderCards(); updateMarkers();
  </script>
</body>
</html>
